"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
const stream_1 = require("stream");
class LineSplitter extends stream_1.Transform {
    constructor(options) {
        super(Object.assign({ readableObjectMode: true }, options));
        this.internalBuffer = [];
        this.eol13 = Buffer.from('\r\n');
        this.eol10 = Buffer.from('\n');
    }
    _transform(chunk, _encoding, next) {
        var index = 0;
        var pos;
        while ((pos = chunk.indexOf(10, index)) != -1) {
            var with13 = pos && chunk[pos - 1] == 13;
            this.push({ line: Buffer.concat([...this.internalBuffer, chunk.slice(index, pos - (with13 ? 1 : 0))]), eol: with13 ? this.eol13 : this.eol10 });
            this.internalBuffer = [];
            index = pos + 1;
        }
        this.internalBuffer.push(chunk.slice(index));
        next();
    }
    _flush(done) {
        if (this.internalBuffer.length && this.internalBuffer.find(x => x.length > 0 || x.byteLength > 0)) {
            this.push({ line: Buffer.concat(this.internalBuffer), eol: Buffer.from('') });
        }
        done();
    }
}
exports.LineSplitter = LineSplitter;
class LineJoiner extends stream_1.Transform {
    constructor(options) {
        super(Object.assign({ writableObjectMode: true }, options));
    }
    _transform(chunk, _encoding, next) {
        this.push(chunk.line);
        this.push(chunk.eol);
        next();
    }
}
exports.LineJoiner = LineJoiner;
class EscapeCharsTransform extends stream_1.Transform {
    constructor(options) {
        var { charsToEscape, prefixChar } = options, superOptions = __rest(options, ["charsToEscape", "prefixChar"]);
        super(Object.assign({ objectMode: true }, superOptions));
        this.prefixBuffer = Buffer.alloc(1, prefixChar);
        this.charsMap = {};
        var self = this;
        charsToEscape.split('').forEach(function (char) {
            var ascii = char.charCodeAt(0);
            self.charsMap[ascii] = true;
        });
    }
    _transform(chunk, _encoding, next) {
        var index = 0;
        var pos = 0;
        var parts = [];
        while (pos < chunk.line.byteLength) {
            if (this.charsMap[chunk.line[pos]]) {
                parts.push(chunk.line.slice(index, pos));
                parts.push(this.prefixBuffer);
                index = pos;
            }
            pos++;
        }
        parts.push(chunk.line.slice(index));
        this.push({ line: Buffer.concat(parts), eol: chunk.eol });
        next();
    }
}
exports.EscapeCharsTransform = EscapeCharsTransform;
async function streamSignalsDone(stream) {
    return new Promise(function (resolve, reject) {
        stream.on('error', function (err) {
            reject(err);
        });
        stream.on('close', function () {
            resolve();
        });
        stream.on('end', function () {
            resolve();
        });
    });
}
exports.streamSignalsDone = streamSignalsDone;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGluZS1zcGxpdHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvbGluZS1zcGxpdHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7Ozs7Ozs7O0FBRWIsbUNBQStFO0FBSS9FLE1BQWEsWUFBYSxTQUFRLGtCQUFTO0lBSXZDLFlBQVksT0FBd0I7UUFDaEMsS0FBSyxpQkFBRSxrQkFBa0IsRUFBQyxJQUFJLElBQUssT0FBTyxFQUFFLENBQUM7UUFKekMsbUJBQWMsR0FBVSxFQUFFLENBQUM7UUFDM0IsVUFBSyxHQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDMUIsVUFBSyxHQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFHaEMsQ0FBQztJQUNELFVBQVUsQ0FBQyxLQUFZLEVBQUUsU0FBZ0IsRUFBRSxJQUFzQjtRQUM3RCxJQUFJLEtBQUssR0FBQyxDQUFDLENBQUM7UUFDWixJQUFJLEdBQVUsQ0FBQztRQUNmLE9BQU0sQ0FBQyxHQUFHLEdBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUMsS0FBSyxDQUFDLENBQUMsSUFBRSxDQUFDLENBQUMsRUFBQztZQUNwQyxJQUFJLE1BQU0sR0FBRyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsR0FBQyxDQUFDLENBQUMsSUFBRSxFQUFFLENBQUM7WUFDckMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFDLEdBQUcsR0FBQyxDQUFDLE1BQU0sQ0FBQSxDQUFDLENBQUEsQ0FBQyxDQUFBLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUMsTUFBTSxDQUFBLENBQUMsQ0FBQSxJQUFJ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QkFDOUIsS0FBSyxHQUFDLEdBQUcsQ0FBQzthQUNiO1lBQ0QsR0FBRyxFQUFFLENBQUM7U0FDVDtRQUNELEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUMsSUFBSSxFQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUMsQ0FBQyxDQUFBO1FBQ3JELElBQUksRUFBRSxDQUFDO0lBQ1gsQ0FBQztDQUNKO0FBOUJELG9EQThCQztBQUVNLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxNQUFhO0lBQ2pELE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBUyxPQUFPLEVBQUUsTUFBTTtRQUN2QyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFTLEdBQUc7WUFDM0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ2YsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBQztZQUNkLE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUE7UUFDRixNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBQztZQUNaLE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFaRCw4Q0FZQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxuaW1wb3J0IHsgVHJhbnNmb3JtLCBUcmFuc2Zvcm1DYWxsYmFjaywgVHJhbnNmb3JtT3B0aW9ucywgU3RyZWFtIH0gZnJvbSBcInN0cmVhbVwiXHJcblxyXG5leHBvcnQgdHlwZSBMaW5lRWxlbWVudCA9IHtsaW5lOkJ1ZmZlciwgZW9sOkJ1ZmZlcn07XHJcblxyXG5leHBvcnQgY2xhc3MgTGluZVNwbGl0dGVyIGV4dGVuZHMgVHJhbnNmb3JtIHtcclxuICAgIHByaXZhdGUgaW50ZXJuYWxCdWZmZXI6QnVmZmVyW109W107XHJcbiAgICBwcml2YXRlIGVvbDEzPUJ1ZmZlci5mcm9tKCdcXHJcXG4nKTtcclxuICAgIHByaXZhdGUgZW9sMTA9QnVmZmVyLmZyb20oJ1xcbicpO1xyXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczpUcmFuc2Zvcm1PcHRpb25zKSB7XHJcbiAgICAgICAgc3VwZXIoe3JlYWRhYmxlT2JqZWN0TW9kZTp0cnVlLCAuLi5vcHRpb25zfSk7XHJcbiAgICB9XHJcbiAgICBfdHJhbnNmb3JtKGNodW5rOkJ1ZmZlciwgX2VuY29kaW5nOnN0cmluZywgbmV4dDpUcmFuc2Zvcm1DYWxsYmFjayl7XHJcbiAgICAgICAgdmFyIGluZGV4PTA7XHJcbiAgICAgICAgdmFyIHBvczpudW1iZXI7XHJcbiAgICAgICAgd2hpbGUoKHBvcz1jaHVuay5pbmRleE9mKDEwLGluZGV4KSkhPS0xKXtcclxuICAgICAgICAgICAgdmFyIHdpdGgxMyA9IHBvcyAmJiBjaHVua1twb3MtMV09PTEzO1xyXG4gICAgICAgICAgICB0aGlzLnB1c2goe2xpbmU6QnVmZmVyLmNvbmNhdChbLi4udGhpcy5pbnRlcm5hbEJ1ZmZlciwgY2h1bmsuc2xpY2UoaW5kZXgscG9zLSh3aXRoMTM/MTowKSldKSwgZW9sOndpdGgxMz90aGlzLmVvbDEzOnRoaXMuZW9sMTB9KVxyXG4gICAgICAgICAgICB0aGlzLmludGVybmFsQnVmZmVyPVtdO1xyXG4gICAgICAgICAgICBpbmRleD1wb3MrMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pbnRlcm5hbEJ1ZmZlci5wdXNoKGNodW5rLnNsaWNlKGluZGV4KSk7XHJcbiAgICAgICAgbmV4dCgpO1xyXG4gICAgfVxyXG4gICAgX2ZsdXNoKGRvbmU6VHJhbnNmb3JtQ2FsbGJhY2spe1xyXG4gICAgICAgIGlmKHRoaXMuaW50ZXJuYWxCdWZmZXIubGVuZ3RoICYmIHRoaXMuaW50ZXJuYWxCdWZmZXIuZmluZCh4PT54Lmxlbmd0aD4wIHx8IHguYnl0ZUxlbmd0aD4wKSl7XHJcbiAgICAgICAgICAgIHRoaXMucHVzaCh7bGluZTpCdWZmZXIuY29uY2F0KHRoaXMuaW50ZXJuYWxCdWZmZXIpLCBlb2w6QnVmZmVyLmZyb20oJycpfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRvbmUoKTtcclxuICAgIH1cclxufSAgICAgICAgICBcclxuXHJcbmV4cG9ydCBjbGFzcyBMaW5lSm9pbmVyIGV4dGVuZHMgVHJhbnNmb3JtIHtcclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6VHJhbnNmb3JtT3B0aW9ucykge1xyXG4gICAgICAgIHN1cGVyKHt3cml0YWJsZU9iamVjdE1vZGU6dHJ1ZSwgLi4ub3B0aW9uc30pO1xyXG4gICAgfVxyXG4gICAgX3RyYW5zZm9ybShjaHVuazpMaW5lRWxlbWVudCwgX2VuY29kaW5nOnN0cmluZywgbmV4dDpUcmFuc2Zvcm1DYWxsYmFjayl7XHJcbiAgICAgICAgdGhpcy5wdXNoKGNodW5rLmxpbmUpO1xyXG4gICAgICAgIHRoaXMucHVzaChjaHVuay5lb2wpO1xyXG4gICAgICAgIG5leHQoKTtcclxuICAgIH1cclxufSAgICAgICAgICBcclxuXHJcbmV4cG9ydCB0eXBlIEVzY2FwZUNoYXJzVHJhbnNmb3JtT3B0aW9ucz17Y2hhcnNUb0VzY2FwZTpzdHJpbmcsIHByZWZpeENoYXI6c3RyaW5nfSAmIFRyYW5zZm9ybU9wdGlvbnM7XHJcblxyXG5leHBvcnQgY2xhc3MgRXNjYXBlQ2hhcnNUcmFuc2Zvcm0gZXh0ZW5kcyBUcmFuc2Zvcm0ge1xyXG4gICAgcHJpdmF0ZSBjaGFyc01hcDp7W2tleTpzdHJpbmddOiB0cnVlfTtcclxuICAgIHByaXZhdGUgcHJlZml4QnVmZmVyOkJ1ZmZlcjtcclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6RXNjYXBlQ2hhcnNUcmFuc2Zvcm1PcHRpb25zKSB7XHJcbiAgICAgICAgdmFyIHtjaGFyc1RvRXNjYXBlLCBwcmVmaXhDaGFyLCAuLi5zdXBlck9wdGlvbnN9ID0gb3B0aW9ucztcclxuICAgICAgICBzdXBlcih7b2JqZWN0TW9kZTp0cnVlLCAuLi5zdXBlck9wdGlvbnN9KTtcclxuICAgICAgICB0aGlzLnByZWZpeEJ1ZmZlcj1CdWZmZXIuYWxsb2MoMSxwcmVmaXhDaGFyKTtcclxuICAgICAgICB0aGlzLmNoYXJzTWFwPXt9O1xyXG4gICAgICAgIHZhciBzZWxmPXRoaXM7XHJcbiAgICAgICAgY2hhcnNUb0VzY2FwZS5zcGxpdCgnJykuZm9yRWFjaChmdW5jdGlvbihjaGFyKXtcclxuICAgICAgICAgICAgdmFyIGFzY2lpOm51bWJlcj1jaGFyLmNoYXJDb2RlQXQoMCk7XHJcbiAgICAgICAgICAgIHNlbGYuY2hhcnNNYXBbYXNjaWldPXRydWU7XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuICAgIF90cmFuc2Zvcm0oY2h1bms6TGluZUVsZW1lbnQsIF9lbmNvZGluZzpzdHJpbmcsIG5leHQ6VHJhbnNmb3JtQ2FsbGJhY2spe1xyXG4gICAgICAgIHZhciBpbmRleD0wO1xyXG4gICAgICAgIHZhciBwb3M9MDtcclxuICAgICAgICB2YXIgcGFydHM6QnVmZmVyW109W107XHJcbiAgICAgICAgd2hpbGUocG9zPGNodW5rLmxpbmUuYnl0ZUxlbmd0aCl7XHJcbiAgICAgICAgICAgIGlmKHRoaXMuY2hhcnNNYXBbY2h1bmsubGluZVtwb3NdXSl7XHJcbiAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGNodW5rLmxpbmUuc2xpY2UoaW5kZXgscG9zKSk7XHJcbiAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKHRoaXMucHJlZml4QnVmZmVyKTtcclxuICAgICAgICAgICAgICAgIGluZGV4PXBvcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwb3MrKztcclxuICAgICAgICB9XHJcbiAgICAgICAgcGFydHMucHVzaChjaHVuay5saW5lLnNsaWNlKGluZGV4KSk7XHJcbiAgICAgICAgdGhpcy5wdXNoKHtsaW5lOkJ1ZmZlci5jb25jYXQocGFydHMpLCBlb2w6Y2h1bmsuZW9sfSlcclxuICAgICAgICBuZXh0KCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzdHJlYW1TaWduYWxzRG9uZShzdHJlYW06U3RyZWFtKTpQcm9taXNlPHZvaWQ+e1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7XHJcbiAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgICAgIHJlamVjdChlcnIpXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc3RyZWFtLm9uKCdjbG9zZScsZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgc3RyZWFtLm9uKCdlbmQnLGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICB9KVxyXG4gICAgfSk7XHJcbn1cclxuIl19